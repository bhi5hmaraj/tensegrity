name: Cleanup Preview Service

on:
  pull_request:
    types: [closed]

env:
  REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  CLOUDSDK_CORE_VERBOSITY: debug
  CLOUDSDK_CORE_LOG_HTTP: 'true'

jobs:
  cleanup:
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    steps:
      - name: Setup gcloud auth (SA JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Debug gcloud context
        run: |
          set -x
          which gcloud
          gcloud --version
          gcloud info
          gcloud config list
          gcloud auth list
          echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}"
          echo "REGION=${{ env.REGION }}"

      - name: Delete preview service (ignore if missing)
        run: |
          set -x
          SERVICE="tensegrity-pr-${{ github.event.number }}"
          gcloud run services delete "$SERVICE" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --quiet || true
